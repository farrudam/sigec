{% extends "dashboard.html" %}
{% block conteudo %}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ base_url }}">
                Home
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <a href="{{ base_url }}/usuarios">
                Usuários
            </a>
        </li>
    </ol>
</nav>


<div class="card border-0 shadow-sm">    
    <div class="card-body">
        <div class="panel-heading"><h4><b>Alterar Foto</b></h4></div>
        
        
        <form action="../../usuario/{{usuario.id}}/alterarFoto" method="post" enctype="multipart/form-data">     
            
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome</label>
                        <input type="text" value="{{usuario.nome}}" name="nome" id="nome" class="form-control" disabled>
                    </div>            
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="matricula" class="form-label">Matrícula</label>
                        <input type="text" value="{{usuario.matricula}}" name="matricula" id="matricula" class="form-control" disabled>
                    </div>
                </div>
            </div> 
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="url_foto" class="form-label">Escolha a foto:</label>
                    <input type="file" name="url_foto" id="url_foto" accept="image/*" class="form-control">
                </div>
            </div>
            
            
            <button type="submit" class="btn btn-success">
                <i class="fa-regular fa-floppy-disk"></i> Salvar
            </button>
            <button id="btn_voltar" type="button" class="btn btn-success" onclick="window.location.href = '{{ base_url }}/usuarios';">Voltar</button>
        </form>
    </div>    
</div>
<hr>
    <div>
        <video id="cameraFeed" width="640" height="480" autoplay></video>
    </div>
    <button id="captureButton">Capturar Foto</button>
    <button id="cancelButton" style="display: none;">Cancelar</button>
    <button id="uploadButton" style="display: none;">Enviar Foto</button>
    <img id="capturedPhoto" style="max-width: 100%;" alt="Captured Photo">
    <div id="successAlert" style="display: none; color: green;">
        Foto enviada com sucesso!
    </div>
    
<script>
    // Parâmetros configuráveis
    const baseUrl = '{{base_url}}';
    const captureSoundURL = `${baseUrl}/src/assets/click.mp3`;
    const uploadUrl = `${baseUrl}/src/assets/img/usuarios`;    

    // IDs dos elementos
    const cameraFeedId = 'cameraFeed';
    const captureButtonId = 'captureButton';
    const cancelButtonId = 'cancelButton';
    const capturedPhotoId = 'capturedPhoto';
    const uploadButtonId = 'uploadButton';
    const successAlertId = 'successAlert';

    const cameraFeed = document.getElementById(cameraFeedId);
    const captureButton = document.getElementById(captureButtonId);
    const cancelButton = document.getElementById(cancelButtonId);
    const capturedPhoto = document.getElementById(capturedPhotoId);
    const uploadButton = document.getElementById(uploadButtonId);
    const successAlert = document.getElementById(successAlertId);

    // Carregar som
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let captureSoundBuffer;

    // Função para carregar som
    function loadSound(url, context) {
        return fetch(url)
            .then(response => response.arrayBuffer())
            .then(data => context.decodeAudioData(data))
            .then(buffer => {
                captureSoundBuffer = buffer;  // Definir a variável globalmente
            })
            .catch(error => {
                console.error('Erro ao carregar o som:', error);
                // Lide com o erro, defina captureSoundBuffer como undefined ou outra lógica adequada
            });
    }

    // Chamar a função para carregar o som
    loadSound(captureSoundURL, audioContext);

    // Função para inicializar webcam
    function initializeWebcam() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                cameraFeed.srcObject = stream;
            })
            .catch(error => {
                console.error('Erro ao acessar a webcam:', error);
            });
    }

    // Chamar a função para inicializar a webcam
    initializeWebcam();

        // Função para ativar/desativar botões
        function toggleButtons(captureEnabled, uploadEnabled, cancelEnabled) {
            captureButton.disabled = !captureEnabled;
            uploadButton.style.display = uploadEnabled ? 'block' : 'none';
            cancelButton.style.display = cancelEnabled ? 'block' : 'none';
        }

        // Utilize delegação de eventos para lidar com eventos em elementos dinâmicos
        document.addEventListener('click', function (event) {
            if (event.target.id === captureButtonId) {
                capturePhoto();
            } else if (event.target.id === cancelButtonId) {
                cancelCapture();
            } else if (event.target.id === uploadButtonId) {
                uploadPhoto();
            }
        });

        // Função para cancelar captura
        function cancelCapture() {
            capturedPhoto.src = '';
            toggleButtons(true, false, false);
        }

        /**
         * Captura uma foto da webcam, redimensiona e exibe-a em um elemento HTML.
         * Ativa/desativa os botões conforme necessário e reproduz um som de captura.
         */
        function capturePhoto() {
            // Cria um canvas para redimensionar a imagem capturada
            const canvas = document.createElement('canvas');

            // Define o tamanho máximo desejado
            const maxWidth = 800;

            // Calcula a escala para redimensionar a imagem
            const scale = Math.min(maxWidth / cameraFeed.videoWidth, 1);

            // Define a largura e altura do canvas de acordo com a escala
            canvas.width = cameraFeed.videoWidth * scale;
            canvas.height = cameraFeed.videoHeight * scale;

            // Obtém o contexto 2D do canvas e desenha a imagem capturada nele
            const context = canvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

            // Define a imagem do elemento capturedPhoto como a imagem do canvas convertida para formato JPEG
            capturedPhoto.src = canvas.toDataURL('image/jpeg', 0.7); // Qualidade de 70%

            // Ativa os botões de upload e cancelar e desativa o botão de capturar
            toggleButtons(false, true, true);

            // Toca o som de captura, se disponível
            if (captureSoundBuffer) {
                const source = audioContext.createBufferSource();
                source.buffer = captureSoundBuffer;
                source.connect(audioContext.destination);
                source.start();
            }
        }

        /**
        * Envia a foto capturada para o servidor usando AJAX (XMLHttpRequest).
        * Exibe um alerta de sucesso se o envio for bem-sucedido.
        */
       function uploadPhoto() {
           // Obtém os dados da foto a partir do atributo src da imagem capturada
           const photoData = capturedPhoto.src.split(',')[1];

           // Obtém a matricula do usuario (pode ser parametrizado conforme necessário)
           const matricula = '{{usuario.matricula}}';

           // Cria um objeto FormData e adiciona os campos necessários (photoData e cpf)
           const formData = new FormData();
           formData.append('photoData', photoData);
           formData.append('matricula', matricula);

           // Inicializa uma instância de XMLHttpRequest
           const xhr = new XMLHttpRequest();

           // Configura a solicitação POST para o URL de upload especificado
           xhr.open('POST', uploadUrl, true);

           // Define a função de retorno de chamada para lidar com a resposta da solicitação AJAX
           xhr.onreadystatechange = function() {
               if (xhr.readyState === XMLHttpRequest.DONE) {
                   console.log(xhr.responseText);
                   if (xhr.status === 200) {
                       var response = JSON.parse(xhr.responseText);
                       if (response.success) {
                           successAlert.style.display = 'block';
                           redireciona();
                       } else {
                           console.error('Erro no upload:', response.message);
                       }
                   } else {
                       console.error('Erro no upload:', xhr.status, xhr.statusText);
                   }
               }
           };

           // Envia os dados da foto para o servidor usando a solicitação AJAX
           xhr.send(formData);
       }
    </script>

{% endblock %}